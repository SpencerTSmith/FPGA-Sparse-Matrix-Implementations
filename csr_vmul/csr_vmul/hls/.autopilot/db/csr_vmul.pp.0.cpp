# 1 "csr_vmul.cpp"
# 1 "<built-in>" 1
# 1 "<built-in>" 3
# 376 "<built-in>" 3
# 1 "<command line>" 1
# 1 "<built-in>" 2
# 1 "/home/spence/Documents/misery/Vivado/Vitis/2024.2/common/technology/autopilot/etc/autopilot_ssdm_op.h" 1
# 105 "/home/spence/Documents/misery/Vivado/Vitis/2024.2/common/technology/autopilot/etc/autopilot_ssdm_op.h"
extern "C" {






    void _ssdm_op_IfRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_IfWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_IfNbRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_IfNbWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_IfCanRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_IfCanWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));


    void _ssdm_StreamRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_StreamWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_StreamNbRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_StreamNbWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_StreamCanRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_StreamCanWrite(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned _ssdm_StreamSize(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_ReadReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_Read(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_WriteReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_Write(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_NbReadReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_CanReadReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_NbWriteReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    unsigned int __attribute__ ((bitwidth(1))) _ssdm_op_CanWriteReq(...) __attribute__ ((nothrow)) __attribute__((overloadable));




    void _ssdm_op_MemShiftRead(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_PrintNone(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_PrintInt(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_PrintDouble(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_Wait(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_Poll(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_Return(...) __attribute__ ((nothrow)) __attribute__((overloadable));


    void _ssdm_op_SpecSynModule(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecTopModule(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecProcessDecl(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecProcessDef(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecPort(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecConnection(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecChannel(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecSensitive(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecModuleInst(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecPortMap(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecReset(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecPlatform(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecClockDomain(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecPowerDomain(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    int _ssdm_op_SpecRegionBegin(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    int _ssdm_op_SpecRegionEnd(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecLoopName(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecLoopTripCount(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    int _ssdm_op_SpecStateBegin(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    int _ssdm_op_SpecStateEnd(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecInterface(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecPipeline(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecDataflowPipeline(...) __attribute__ ((nothrow)) __attribute__((overloadable));


    void _ssdm_op_SpecLatency(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecParallel(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecProtocol(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecOccurrence(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecResource(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecResourceLimit(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecCHCore(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecFUCore(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecIFCore(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecIPCore(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecMemCore(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecExt(...) __attribute__ ((nothrow)) __attribute__((overloadable));




    void _ssdm_SpecArrayDimSize(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_RegionBegin(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_RegionEnd(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_InlineAll(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_InlineLoop(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_Inline(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_InlineSelf(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_InlineRegion(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecArrayMap(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecArrayPartition(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecArrayReshape(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecStream(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecStable(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecStableContent(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecBindPort(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecPipoDepth(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecExpr(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecExprBalance(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecDependence(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecLoopMerge(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecLoopFlatten(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecLoopRewind(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_SpecFuncInstantiation(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecFuncBuffer(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecFuncExtract(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecConstant(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_DataPack(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_SpecDataPack(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void _ssdm_op_SpecBitsMap(...) __attribute__ ((nothrow)) __attribute__((overloadable));
    void _ssdm_op_SpecLicense(...) __attribute__ ((nothrow)) __attribute__((overloadable));

    void __xilinx_ip_top(...) __attribute__ ((nothrow)) __attribute__((overloadable));


}
# 2 "<built-in>" 2
# 1 "csr_vmul.cpp" 2
# 1 "./csr_vmul.h" 1


constexpr int MAX_ELEMENTS = 1024;
constexpr int MAX_UNROLL = 16;

constexpr int WIDEN_BITWIDTH = 512;

struct CSR_Matrix {
  int row_count;
  int col_count;
  int non_zero_count;



  int row_pointers[MAX_ELEMENTS];
  int col_indices[MAX_ELEMENTS];
  float values[MAX_ELEMENTS];
};

struct Dense_Matrix {
  int row_count;
  int col_count;
  float values[MAX_ELEMENTS * MAX_ELEMENTS];
};

struct Vector {
  float values[MAX_ELEMENTS];
  int count;
};



__attribute__((sdx_kernel("csr_vmul", 0))) void csr_vmul(const CSR_Matrix *matrix, const Vector *vector, Vector *out);
# 2 "csr_vmul.cpp" 2

__attribute__((sdx_kernel("csr_vmul", 0))) void csr_vmul(const CSR_Matrix *matrix, const Vector *vector, Vector *out) {
#line 1 "directive"
#pragma HLSDIRECTIVE TOP name=csr_vmul
# 3 "csr_vmul.cpp"

# 17 "csr_vmul.cpp"
#pragma HLS DISAGGREGATE variable = matrix
#pragma HLS INTERFACE s_axilite port = matrix->row_count bundle = control
#pragma HLS INTERFACE s_axilite port = matrix->col_count bundle = control
#pragma HLS INTERFACE s_axilite port = matrix->non_zero_count bundle = control

#pragma HLS INTERFACE m_axi port = matrix->row_pointers offset = slave bundle = BUNDLE_A depth = MAX_ELEMENTS max_widen_bitwidth = WIDEN_BITWIDTH

#pragma HLS INTERFACE m_axi port = matrix->col_indices offset = slave bundle = BUNDLE_B depth = MAX_ELEMENTS max_widen_bitwidth = WIDEN_BITWIDTH

#pragma HLS INTERFACE m_axi port = matrix->values offset = slave bundle = BUNDLE_C depth = MAX_ELEMENTS max_widen_bitwidth = WIDEN_BITWIDTH



#pragma HLS DISAGGREGATE variable = vector
#pragma HLS INTERFACE m_axi port = vector->values offset = slave bundle = BUNDLE_D depth = MAX_ELEMENTS max_widen_bitwidth = WIDEN_BITWIDTH


#pragma HLS INTERFACE s_axilite port = vector->count bundle = control

#pragma HLS DISAGGREGATE variable = out
#pragma HLS INTERFACE m_axi port = out->values offset = slave bundle = gmem
#pragma HLS INTERFACE s_axilite port = out->count bundle = control



#pragma HLS INTERFACE s_axilite port = return bundle = control

 out->count = matrix->row_count;

  float local_vector[MAX_ELEMENTS];
  load_vector:
  for (int i = 0; i < vector->count; i++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS PIPELINE
 local_vector[i] = vector->values[i];
  }

  int local_col_indices[MAX_ELEMENTS];
  load_col_indices:
  for (int i = 0; i < matrix->non_zero_count; i++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS PIPELINE
 local_col_indices[i] = matrix->col_indices[i];
  }

  int local_row_pointers[MAX_ELEMENTS];
  load_row_pointers:
  for (int i = 0; i < matrix->row_count + 1; i++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS PIPELINE
 local_row_pointers[i] = matrix->row_pointers[i];
  }

  float local_matrix_values[MAX_ELEMENTS];
  load_matrix_values:
  for (int i = 0; i < matrix->non_zero_count; i++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS PIPELINE
 local_matrix_values[i] = matrix->values[i];
  }

  every_row:
  for (int row = 0; row < matrix->row_count; row++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS PIPELINE

 float partial_sums[MAX_UNROLL] = {0};
#pragma HLS ARRAY_PARTITION variable=partial_sums complete

 unroll_partial:
    for (int i = local_row_pointers[row]; i < local_row_pointers[row + 1]; i += MAX_UNROLL) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS

 partials:
      for (int j = 0; j < MAX_UNROLL && (i + j) < local_row_pointers[row + 1]; j++) {
#pragma HLS LOOP_TRIPCOUNT max = MAX_ELEMENTS
#pragma HLS UNROLL factor = MAX_UNROLL

 partial_sums[j] = local_matrix_values[i + j] * local_vector[local_col_indices[i + j]];
      }
    }

    float true_sum = 0;

    add_all:
    for (int i = 0; i < MAX_UNROLL; i++) {
#pragma HLS UNROLL
 true_sum += partial_sums[i];
    }

    out->values[row] = true_sum;
  }
}
